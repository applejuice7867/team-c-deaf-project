<!DOCTYPE html>
<html lang="" id="html-root">
<head>
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3849359736093231"
     crossorigin="anonymous"></script>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Settings / 設定</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <main>
    <h1>
      <span class="lang-zh">設定</span>
      <span class="lang-en">Settings</span>
    </h1>

    <div style="margin-bottom:1rem;">
      <div id="auth-status" style="font-weight:bold;margin-bottom:0.5rem;">未登入</div>
      <button id="btn-sign-in" class="large-button" style="width:100%;max-width:320px;">
        <span class="lang-zh">以 Google 登入</span>
        <span class="lang-en">Sign in with Google</span>
      </button>
      <button id="btn-sign-out" class="large-button" style="width:100%;max-width:320px;display:none;">
        <span class="lang-zh">登出</span>
        <span class="lang-en">Sign Out</span>
      </button>
    </div>

    <div style="margin-bottom:2rem;">
      <label for="language-select">
        <span class="lang-zh">語言</span>
        <span class="lang-en">Language</span>
      </label>
      <select id="language-select" style="width:100%;max-width:320px;">
        <option value="zh-HK">中文</option>
        <option value="en">English</option>
      </select>
    </div>
    <div style="margin-bottom:2rem;">
      <button id="theme-toggle-button" class="large-button" style="width:100%;max-width:320px;">
      </button>
    </div>
    <div style="margin-bottom:2rem;">
      <button id="save-settings" class="large-button" style="width:100%;max-width:320px;">
        <span class="lang-zh">儲存設定</span>
        <span class="lang-en">Save Settings</span>
      </button>
    </div>
  </main>
  <div class="bottom-nav">
    <button id="nav-home" class="nav-btn" aria-label="主頁">
      <svg width="24px" height="24px" viewBox="0 0 24 24" stroke-width="1.5" fill="none" xmlns="http://www.w3.org/2000/svg" color="currentColor"><path d="M2 8L11.7317 3.13416C11.9006 3.04971 12.0994 3.04970 12.2683 3.13416L22 8" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path><path d="M20 11V19C20 20.1046 19.1046 21 18 21H6C4.89543 21 4 20.1046 4 19V11" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path></svg>
    </button>
    <button id="nav-transport" class="nav-btn" aria-label="交通">
      <svg width="24px" height="24px" viewBox="0 0 24 24" stroke-width="1.5" fill="none" xmlns="http://www.w3.org/2000/svg" color="currentColor"><path d="M7 16.01L7.01 15.9989" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path><path d="M17 16.01L17.01 15.9989" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path><path d="M3 12H21V19C21 19.5523 20.5523 20 20 20H4C3.44772 20 3 19.5523 3 19V12Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path><path d="M21 8V6C21 3.79086 19.2091 2 17 2H7C4.79086 2 3 3.79086 3 6V8" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path><path d="M7 8L17 8" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path><path d="M4.5 20V21.9C4.5 22.2314 4.76863 22.5 5.1 22.5H7.9C8.23137 22.5 8.5 22.2314 8.5 21.9V20" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"></path><path d="M15.5 20V21.9C15.5 22.2314 15.7686 22.5 16.1 22.5H18.9C19.2314 22.5 19.5 22.2314 19.5 21.9V20" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"></path></svg>
    </button>
    <button id="nav-settings" class="nav-btn" aria-label="設定">
      <img src="../images/setting-icon.png" alt="設定" class="settings-icon-light" style="height:32px;width:32px;object-fit:contain;" />
      <img src="../images/settings-icon-dark.png" alt="設定" class="settings-icon-dark" style="height:32px;width:32px;object-fit:contain;" />
    </button>
  </div>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <script src="firebase.js"></script>
  <script src="prefs.js"></script>
  <script src="script.js"></script>
  <script>
    // On DOMContentLoaded, set body class and UI to match saved settings, and wire Firebase auth
    document.addEventListener('DOMContentLoaded', function() {
      // Language
      const lang = localStorage.getItem('lang') || 'zh-HK';
      document.body.classList.remove('lang-zh-HK', 'lang-en');
      document.body.classList.add(lang === 'en' ? 'lang-en' : 'lang-zh-HK');
      document.getElementById('language-select').value = lang;
      // Theme
      let selectedTheme = localStorage.getItem('theme') || 'light';
      const themeToggleBtn = document.getElementById('theme-toggle-button');
      function setTheme(theme) {
        selectedTheme = theme;
        if (theme === 'dark') {
          document.body.classList.add('dark-mode');
          themeToggleBtn.innerHTML = `<svg class="theme-toggle-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
    <circle cx="12" cy="12" r="4"/>
    <path d="M12 2v2"/>
    <path d="M12 20v2"/>
    <path d="M4.93 4.93l1.41 1.41"/>
    <path d="M17.66 17.66l1.41 1.41"/>
    <path d="M2 12h2"/>
    <path d="M20 12h2"/>
    <path d="M4.93 19.07l1.41-1.41"/>
    <path d="M17.66 6.34l1.41-1.41"/>
  </svg>`;
        } else { // Light mode
          document.body.classList.remove('dark-mode');
          themeToggleBtn.innerHTML = `<svg class="theme-toggle-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
    <path d="M21 12.8A8.5 8.5 0 0 1 11.2 3a7 7 0 1 0 9.8 9.8Z"/>
  </svg>`;
        }
      }
      setTheme(selectedTheme);
      themeToggleBtn.addEventListener('click', () => {
        selectedTheme = (selectedTheme === 'dark' ? 'light' : 'dark');
        setTheme(selectedTheme);
      });

      // Firebase Auth wiring
      const signInBtn = document.getElementById('btn-sign-in');
      const signOutBtn = document.getElementById('btn-sign-out');
      const authStatus = document.getElementById('auth-status');

      function updateAuthUI(user) {
        const langNow = localStorage.getItem('lang') || 'zh-HK';
        if (user) {
          if (authStatus) authStatus.textContent = langNow === 'en' ? `Signed in as ${user.email || user.displayName || user.uid}` : `已登入：${user.email || user.displayName || user.uid}`;
          if (signInBtn) signInBtn.style.display = 'none';
          if (signOutBtn) signOutBtn.style.display = 'inline-block';
        } else {
          if (authStatus) authStatus.textContent = langNow === 'en' ? 'Not signed in' : '未登入';
          if (signInBtn) signInBtn.style.display = 'inline-block';
          if (signOutBtn) signOutBtn.style.display = 'none';
        }
      }

      if (window.firebaseReady && window.auth) {
        window.auth.onAuthStateChanged(updateAuthUI);

        if (signInBtn) {
          signInBtn.addEventListener('click', async function() {
            try {
              const provider = new firebase.auth.GoogleAuthProvider();
              await window.auth.signInWithPopup(provider);
            } catch (e) {
              console.warn('Sign-in failed:', e);
              alert('Sign-in failed: ' + (e && e.message ? e.message : e));
            }
          });
        }
        if (signOutBtn) {
          signOutBtn.addEventListener('click', async function() {
            try {
              await window.auth.signOut();
            } catch (e) {
              console.warn('Sign-out failed:', e);
            }
          });
        }
      }

      // Save Settings button
      document.getElementById('save-settings').addEventListener('click', async function() {
        const currentLang = document.getElementById('language-select').value;
        localStorage.setItem('lang', currentLang);
        localStorage.setItem('theme', selectedTheme);

        // Save to Firestore if signed in
        if (window.firebaseReady && window.auth && window.db && window.auth.currentUser) {
          try {
            const uid = window.auth.currentUser.uid;
            await window.db.collection('users').doc(uid).set({
              lang: currentLang,
              theme: selectedTheme,
              updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            }, { merge: true });
          } catch (e) {
            console.warn('Saving prefs to Firestore failed:', e);
          }
        }
        alert(currentLang === 'en' ? 'Settings saved!' : '設定已儲存！');
        window.location.reload();
      });
    });
  </script>
</body>
</html>
