<!DOCTYPE html>
<html lang="" id="html-root">
<head>
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3849359736093231"
     crossorigin="anonymous"></script>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Settings / Ë®≠ÂÆö</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <main>
    <h1>
      <span class="lang-zh">Ë®≠ÂÆö</span>
      <span class="lang-en">Settings</span>
    </h1>

    <div style="margin-bottom:1rem;">
      <div id="auth-status" style="font-weight:bold;margin-bottom:0.5rem;">Êú™ÁôªÂÖ•</div>
      <button id="btn-sign-in" class="large-button" style="width:100%;max-width:320px;">
        <span class="lang-zh">‰ª• Google ÁôªÂÖ•</span>
        <span class="lang-en">Sign in with Google</span>
      </button>
      <button id="btn-sign-out" class="large-button" style="width:100%;max-width:320px;display:none;">
        <span class="lang-zh">ÁôªÂá∫</span>
        <span class="lang-en">Sign Out</span>
      </button>
    </div>

    <div style="margin-bottom:2rem;">
      <label for="language-select">
        <span class="lang-zh">Ë™ûË®Ä</span>
        <span class="lang-en">Language</span>
      </label>
      <select id="language-select" style="width:100%;max-width:320px;">
        <option value="zh-HK">‰∏≠Êñá</option>
        <option value="en">English</option>
      </select>
    </div>
    <div style="margin-bottom:2rem;">
      <button id="theme-toggle-button" class="large-button" style="width:100%;max-width:320px;">
        <span class="lang-zh">ÂàáÊèõ‰∏ªÈ°å</span>
        <span class="lang-en">Toggle Theme</span>
      </button>
    </div>
    <div style="margin-bottom:2rem;">
      <button id="save-settings" class="large-button" style="width:100%;max-width:320px;">
        <span class="lang-zh">ÂÑ≤Â≠òË®≠ÂÆö</span>
        <span class="lang-en">Save Settings</span>
      </button>
    </div>
  </main>
  <div class="bottom-nav">
    <button id="nav-home" class="nav-btn" aria-label="‰∏ªÈ†Å">
      <span style="font-size:2rem;">üè†</span>
    </button>
    <button id="nav-settings" class="nav-btn" aria-label="Ë®≠ÂÆö">
      <img src="../images/setting-icon.png" alt="Ë®≠ÂÆö" class="settings-icon-light" style="height:32px;width:32px;object-fit:contain;" />
      <img src="../images/settings-icon-dark.png" alt="Ë®≠ÂÆö" class="settings-icon-dark" style="height:32px;width:32px;object-fit:contain;" />
    </button>
  </div>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <script src="firebase.js"></script>
  <script src="prefs.js"></script>
  <script src="script.js"></script>
  <script>
    // On DOMContentLoaded, set body class and UI to match saved settings, and wire Firebase auth
    document.addEventListener('DOMContentLoaded', function() {
      // Language
      const lang = localStorage.getItem('lang') || 'zh-HK';
      document.body.classList.remove('lang-zh-HK', 'lang-en');
      document.body.classList.add(lang === 'en' ? 'lang-en' : 'lang-zh-HK');
      document.getElementById('language-select').value = lang;
      // Theme
      let selectedTheme = localStorage.getItem('theme') || 'light';
      const themeToggleBtn = document.getElementById('theme-toggle-button');
      function setTheme(theme) {
        selectedTheme = theme;
        if (theme === 'dark') {
          document.body.classList.add('dark-mode');
          themeToggleBtn.textContent = '‚òÄÔ∏è';
          themeToggleBtn.style.backgroundColor = '#1a1a1a';
          themeToggleBtn.style.color = 'white';
        } else {
          document.body.classList.remove('dark-mode');
          themeToggleBtn.textContent = 'üåô';
          themeToggleBtn.style.backgroundColor = 'white';
          themeToggleBtn.style.color = 'black';
        }
      }
      setTheme(selectedTheme);
      themeToggleBtn.addEventListener('click', () => {
        selectedTheme = (selectedTheme === 'dark' ? 'light' : 'dark');
        setTheme(selectedTheme);
      });

      // Firebase Auth wiring
      const signInBtn = document.getElementById('btn-sign-in');
      const signOutBtn = document.getElementById('btn-sign-out');
      const authStatus = document.getElementById('auth-status');

      function updateAuthUI(user) {
        const langNow = localStorage.getItem('lang') || 'zh-HK';
        if (user) {
          if (authStatus) authStatus.textContent = langNow === 'en' ? `Signed in as ${user.email || user.displayName || user.uid}` : `Â∑≤ÁôªÂÖ•Ôºö${user.email || user.displayName || user.uid}`;
          if (signInBtn) signInBtn.style.display = 'none';
          if (signOutBtn) signOutBtn.style.display = 'inline-block';
        } else {
          if (authStatus) authStatus.textContent = langNow === 'en' ? 'Not signed in' : 'Êú™ÁôªÂÖ•';
          if (signInBtn) signInBtn.style.display = 'inline-block';
          if (signOutBtn) signOutBtn.style.display = 'none';
        }
      }

      if (window.firebaseReady && window.auth) {
        window.auth.onAuthStateChanged(updateAuthUI);

        if (signInBtn) {
          signInBtn.addEventListener('click', async function() {
            try {
              const provider = new firebase.auth.GoogleAuthProvider();
              await window.auth.signInWithPopup(provider);
            } catch (e) {
              console.warn('Sign-in failed:', e);
              alert('Sign-in failed: ' + (e && e.message ? e.message : e));
            }
          });
        }
        if (signOutBtn) {
          signOutBtn.addEventListener('click', async function() {
            try {
              await window.auth.signOut();
            } catch (e) {
              console.warn('Sign-out failed:', e);
            }
          });
        }
      }

      // Save Settings button
      document.getElementById('save-settings').addEventListener('click', async function() {
        const currentLang = document.getElementById('language-select').value;
        localStorage.setItem('lang', currentLang);
        localStorage.setItem('theme', selectedTheme);

        // Save to Firestore if signed in
        if (window.firebaseReady && window.auth && window.db && window.auth.currentUser) {
          try {
            const uid = window.auth.currentUser.uid;
            await window.db.collection('users').doc(uid).set({
              lang: currentLang,
              theme: selectedTheme,
              updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            }, { merge: true });
          } catch (e) {
            console.warn('Saving prefs to Firestore failed:', e);
          }
        }
        alert(currentLang === 'en' ? 'Settings saved!' : 'Ë®≠ÂÆöÂ∑≤ÂÑ≤Â≠òÔºÅ');
        window.location.reload();
      });
    });
  </script>
</body>
</html>
